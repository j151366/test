--('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')

--18842064
--select count(1) from [MRS].[dbo].[tblBB] where [Fiscal Year] >= 'FY18'

--2101807/18842064 can't show
--select count(1) from [MRS].[dbo].[tblBB] where [Fiscal Year] >= 'FY18' and [Sales Employee Code] IN ('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')
--select * from [MRS].[dbo].[tblBacklog]

--drop table #temp1
--drop table #temp2

--total need to be matched
--select count(1) from #temp1
--select * from #Temp4 WHERE MaxRow = 1 and [SO Sold to Party Code] is not null
--select count(1) from #Temp4 WHERE MaxRow > 1 and [SO Sold to Party Code] is not null



select distinct [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Material], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]
into #temp1
from [MRS].[dbo].[tblBB]
where [Fiscal Year] >= 'FY18' and [Sales Employee Code] IN ('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')

select [Sold to Party Code], [Supplier Prefix], [Material], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee], sum([CSD Value]) as [CSD Value]
into #temp2
from [MRS].[dbo].[tblBacklog]
where [Sales Employee Code] NOT IN ('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')
group by [Sold to Party Code], [Supplier Prefix], [Material], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]

--346073
select
a.[Fiscal Month]
, a.[Sold to Party Code]
, a.[Supplier Prefix]
, a.[Material]
, a.[Sub-Region]
, a.[Sales Team]
, a.[Sales Employee Code]
, a.[Sales Employee]
, [SO Sold to Party Code] = b.[Sold to Party Code]
, [SO Supplier Prefix] = b.[Supplier Prefix]
, [SO Material] = b.[Material]
, [SO Sub-Region] = b.[Sub-Region]
, [SO Sales Team] = b.[Sales Team]
, [SO Sales Employee Code] = b.[Sales Employee Code]
, [SO Sales Employee] = b.[Sales Employee]
, [SO CSD Value] = b.[CSD Value]
into #temp3
from #temp1 a
left join #temp2 b
on a.[Sold to Party Code] = b.[Sold to Party Code]
and a.[Supplier Prefix] = b.[Supplier Prefix]
and a.[Material] = b.[Material]

--how to identify one-to-many scenario
WITH RowOrders AS  
( 
select *, ROW_NUMBER() OVER (PARTITION BY [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Material], [Sub-Region], [Sales Team], [Sales Employee Code] ORDER BY [SO Sales Employee Code]) AS Row
from #temp3
)   
select *, MAX(Row) OVER (PARTITION BY [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Material], [Sub-Region], [Sales Team], [Sales Employee Code] ) AS MaxRow
into #Temp4
from RowOrders
--WHERE MaxRow = 1 

--select * from #Temp4
--select count(1) from #temp1
--select count(1) from #Temp4 WHERE MaxRow > 1 and [SO Sold to Party Code] is not null
--select count(1) from #Temp4 WHERE [SO Sold to Party Code] is null
--select count(1) from #Temp4 WHERE MaxRow > 1 and Row = 1
select * from #Temp4 WHERE MaxRow = 1 and [SO Sold to Party Code] is not null
--select * from #Temp4 WHERE MaxRow > 1 and [Sales Team] <> [SO Sales Team]
select * from #Temp4 WHERE [SO Sold to Party Code] is null
select * from #Temp4 WHERE MaxRow > 1
--Need to add [Sub-Region] and [Sales Team]




---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------

--select count(1) from #Temp5
--select all can't be matched 
select * from #Temp4 WHERE [SO Sold to Party Code] is null

select distinct [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]
into #Temp5
from #Temp4 where [SO Sold to Party Code] is null


--drop table #temp6
select [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee], sum([CSD Value]) as [CSD Value]
into #temp6
from [MRS].[dbo].[tblBacklog]
where [Sales Employee Code] NOT IN ('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')
group by [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]


select
a.[Fiscal Month]
, a.[Sold to Party Code]
, a.[Supplier Prefix]
, a.[Sub-Region]
, a.[Sales Team]
, a.[Sales Employee Code]
, a.[Sales Employee]
, [SO Sold to Party Code] = b.[Sold to Party Code]
, [SO Supplier Prefix] = b.[Supplier Prefix]
, [SO Sub-Region] = b.[Sub-Region]
, [SO Sales Team] = b.[Sales Team]
, [SO Sales Employee Code] = b.[Sales Employee Code]
, [SO Sales Employee] = b.[Sales Employee]
, [SO CSD Value] = b.[CSD Value]
into #temp7
from #Temp5 a
left join #temp6 b
on a.[Sold to Party Code] = b.[Sold to Party Code]
and a.[Supplier Prefix] = b.[Supplier Prefix]

WITH RowOrders AS  
( 
select *, ROW_NUMBER() OVER (PARTITION BY [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code] ORDER BY [SO Sales Employee Code]) AS Row
from #temp7
)   
select *, MAX(Row) OVER (PARTITION BY [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code] ) AS MaxRow
into #temp8
from RowOrders

--select * from #temp8
select * from #temp8 WHERE MaxRow = 1 and [SO Sold to Party Code] is not null
select * from #temp8 WHERE MaxRow > 1
select * from #temp8 WHERE [SO Sold to Party Code] is null




---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------

--select * from #temp8 WHERE [SO Sold to Party Code] is null
select distinct [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]
into #temp9
from #temp8 where [SO Sold to Party Code] is null

--drop table #tempbb
select [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee], [Billing] = SUM([Billing]), [Booking] = SUM([Booking]), [Booking + Biliing] = SUM([Booking]) + SUM([Billing]), [Date] = max([Date])
into #tempbb
from mrs..tblBB with (nolock)
where 
[Sales Employee Code] NOT IN ('042865', '914972', '045628', 'P02792', '042832', '914212', '909689', '043858', '913607', '044801', '-', '043771', '913608', '911593', '913976', '916919', '043141', '042927', '910108', '903167', '914328', '902592', '911640', '045709', '041668', '909912', '915328', '916569', '904547', '042618', '904105', '904262', '910619', '909068', '906304', '043707', '910506', '915326', '909294', '915317', '904730', '903020', '999999', '914192', '914066', '042294', '905430', '906087', '903050', '915211', '913712', '916134', '042095', '913024', '915823', '042351', '915320', '042348', '914120', '910034', '042275', '906447', '041865', '904185', '915247', '042340', '906598', '916272', '901825', '041231', '915000', '906327', '915445', '906069', '903022', '908815', '911313', '912221', '908620', '909894', '907039', '908906', '916203', '042315', '904938', '913905', '903770', '912531', '912582', '041237', '913474', '912546', '912535', '914254', '917063', '914233', '915855', '912562', '052558', '045335', '914787', '041407', '907315', '042732', '910463', '907562', '913155', '916417', '902701', '042211', '915344', '916730', '910566', '051265', '913896', '909304', '915063', '044273', '909817', '908951', '916313', '042680', '911321', '915399', '905882', '045262', '905976', '043595', '045426', '913572', '909004', '044425', '912258', '041677', '902715', '903583', '902100', '916770', '045444', '901680', '900297', '042971', '908724', '902549', '900382', '912371', '916878', '041480', '906546', '041283', '908764', '916029', '915893', '905865', '903144', '#', '047309', '914311', '916608', '910904', '042566', '052071', '914901', 'P03327', '914990', '910896', '042264', '903067', '043893', '916074', '043032', '912649', '912648', '912608', '912616', '912633', '912635', '912611', '912619', '915244', '904727', '915250', '901567', '915241', '045204', '905511', '901541', '043156', '907347', '916491', '909947', '042203', '907488', '907464', '044375', '916346', '907421', '907540', '915348', '041569', '907541', '916874', '907555', '910830', '044519', '047302', '916687', '915967', '044476', '911902', '907591', '915009', '907550', '907453', '914925', '043100', '912367', '916639', '915212', '914802', '915215', '916693', '915480', '916538', '912755', '913881', '914937', '907616', '907611', '915900', '046900', '910901', '915272', '916996', '915279', '915276', '915319', '916165', '915261', '915327', '915260', '916041', '042291', '915901', '045405', '907196', '913326', '909832', '901557', '915323', '915267', '043658', '914146', '911697', '045105', '912603', '910504', '914303', '041686', '914147', '041554', '042001', '913880', '914387', '902007', '901287', '911386', '911835', '908701', '901676', '901864', '912301', '043652', '903111', '903108', '903155', '041641', '044382', '909937', '900460', '903142', '907660', '911939', '903576', '042745', '909996', '904202', '903274', '050435', '907753', '85020333', '915237', '907826', 'P02621', '901358', '909105', '906573', '900307', '915044', '916744', '914421', '916702', '904498', '914796', '042045', '044465', '909911', '914091', 'P03530', '904002', '915473', '913093', '913327', '909323', '911008', '916064', '909120', '915448', '909114', '904839', '909157', '909128', '909143', '907274', '044352', '909154', '911915', '909134', '909118', '909133', '042990', '916743', '917010', '042602', '042035', '916701', '044365', '913615', '915469', '042161', '903265', '915232', '908586', '043026', '909933', '901836', '905322', '910486', '902464', '046987', '908977', '906415', '915271', '916039', '916756', '903249', '041223', '902551', '043931', '045691', 'P02816', '044638', '053319', '914098', '905390', '907292', '904564', '052647', '908920', '914101', '044340', '903496', '915487', '912621', '912625', '912624', '914998', '900488', '915790', '904297', '904102', '041190', '911705', '042499', '914924', '910427', '042562', '915506', '916037', '910442', '916135', '912589', '909280', '901505', '907800', '905397', '911654', '905494', '042748', '912734', '908682', '915522', '901997', '041426', '916591', '908846', '916915', '904832', '901315', '900260', '906358', '903222', '903236', '903204', '907167', '913664', '902076', '917129', '900290', '907572', '912626', '915300', '915285', '915309', '911832', '915766', '911362', '907482', '042563', '912193', '907466', '907336', '913389', '916565', '913610', '914307', '916305', '900293', '904490', '047197', '908954', '902337', '043208', '908841', '043223', '905829', '905825', '045512', '914109', '044211', '901455', '904369', '907525', '042752', '908657', '909115', '913025', '909297', '043870', '8027', '906585', '907748', '909913', '910162', '041276', '905875', '905869', '905784', '912622', '905854', '905810', '905876', '905761', '905821', '905755', '905249', '905746', '905747', '905748', '905751', '905756', '905758', '905759', '905760', '905764', '905765', '905766', '905769', '905770', '905771', '905772', '905781', '905782', '905783', '905787', '905788', '905789', '905790', '905791', '905792', '905793', '905797', '905798', '905799', '905802', '905803', '905804', '905805', '905806', '905807', '905808', '905811', '905814', '905815', '905816', '905818', '905819', '905820', '905822', '905830', '905831', '905832', '905836', '905840', '905841', '905844', '905845', '905846', '905847', '905853', '905855', '905856', '905857', '905858', '905860', '905861', '905863', '905864', '905868', '905870', '905871', '905877', '905878', '905880', '905881', '905883', '905885', '905886', '905887', '905890', '905891', '905892', '905893', '905894', '905895', '905896', '905901', '905909', '905910', '905911', '908933', '912623')
and [Fiscal Year] >= 'FY18'
group by [Fiscal Month], [Sold to Party Code], [Supplier Prefix], [Sub-Region], [Sales Team], [Sales Employee Code], [Sales Employee]


--select count(1) from #temp9
select
[Fiscal Month] = a.[Fiscal Month]
, [Sold to Party Code] = a.[Sold to Party Code]
, [Supplier Prefix] = a.[Supplier Prefix]
, [Sub-Region] = a.[Sub-Region]
, [Sales Team] = a.[Sales Team]
, [Sales Employee Code] = a.[Sales Employee Code]
, [Sales Employee] = a.[Sales Employee]
, [BB Latest Fiscal Month] = b.[Fiscal Month]
, [BB Latest Sold to Party Code] = b.[Sold to Party Code]
, [BB Latest Supplier Prefix] = b.[Supplier Prefix]
, [BB Latest Sub-Region] = b.[Sub-Region]
, [BB Latest Sales Team] = b.[Sales Team]
, [BB Latest Sales Employee Code] = b.[Sales Employee Code]
, [BB Latest Sales Employee] = b.[Sales Employee]
, [BB Latest Booking + Biliing] = b.[Booking + Biliing]
, [BB Latest Date] = b.[Date]
from #temp9 a
left join #tempbb b
on a.[Fiscal Month] < b.[Fiscal Month]
and a.[Sold to Party Code] = b.[Sold to Party Code]
and a.[Supplier Prefix] = b.[Supplier Prefix]
